name: Deploy Canary and Promote (with metrics gate)

on:
  workflow_dispatch:
    inputs:
      model_uri:
        description: "MLflow model URI to deploy (e.g. models:/iris-random-forest/Production)"
        required: false
  repository_dispatch:
    types:
      - mlflow-model-promoted

permissions:
  contents: read
  id-token: write

env:
  CHART_PATH: infra/helm/ml-model-chart
  RELEASE_NAME: ml-model
  OBSERVATION_PORT: 18080
  MODEL_REGISTRY_NAME: iris-random-forest
  MODEL_STAGE: production

jobs:
  build-and-push:
    name: Build and push container
    runs-on: ubuntu-latest
    outputs:
      image: ${{ steps.build.outputs.image }}
      model_uri: ${{ steps.resolve-model.outputs.model_uri }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v2

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2

      - name: Login to registry
        uses: docker/login-action@v2
        with:
          registry: ${{ secrets.REGISTRY_HOST }}
          username: ${{ secrets.REGISTRY_USER }}
          password: ${{ secrets.REGISTRY_TOKEN }}

      - name: Resolve model URI
        id: resolve-model
        env:
          PAYLOAD_MODEL_URI: ${{ github.event.client_payload.model_uri }}
          INPUT_MODEL_URI: ${{ github.event.inputs.model_uri }}
        run: |
          if [ -n "${PAYLOAD_MODEL_URI}" ]; then
            MODEL_URI="${PAYLOAD_MODEL_URI}"
          elif [ -n "${INPUT_MODEL_URI}" ]; then
            MODEL_URI="${INPUT_MODEL_URI}"
          else
            MODEL_URI="models:/${{ env.MODEL_REGISTRY_NAME }}/${{ env.MODEL_STAGE }}"
          fi
          echo "Using MLflow model URI: ${MODEL_URI}"
          echo "MODEL_URI=${MODEL_URI}" >> "$GITHUB_ENV"
          echo "model_uri=${MODEL_URI}" >> "$GITHUB_OUTPUT"

      - name: Build and push
        id: build
        uses: docker/build-push-action@v4
        with:
          context: .
          file: docker/Dockerfile
          push: true
          tags: ${{ secrets.REGISTRY_HOST }}/${{ secrets.REGISTRY_REPO }}:${{ github.sha }}
          build-args: |
            MODEL_URI=${{ env.MODEL_URI }}
            MLFLOW_TRACKING_URI=${{ secrets.MLFLOW_TRACKING_URI }}
      - name: Set image output
        run: echo "image=${{ secrets.REGISTRY_HOST }}/${{ secrets.REGISTRY_REPO }}:${{ github.sha }}" >> "$GITHUB_OUTPUT"

  deploy-canary:
    name: Deploy canary and evaluate metrics
    needs: build-and-push
    runs-on: ubuntu-latest
    env:
      MODEL_URI: ${{ needs.build-and-push.outputs.model_uri }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup kubectl
        uses: azure/setup-kubectl@v3
        with:
          version: '1.29.0'

      - name: Install Helm
        run: |
          curl https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3 | bash

      - name: Configure kubeconfig
        env:
          KUBE_CONFIG_DATA: ${{ secrets.KUBE_CONFIG_DATA }}
        run: |
          echo "$KUBE_CONFIG_DATA" | base64 --decode > kubeconfig
          export KUBECONFIG=$(pwd)/kubeconfig
          kubectl version --client

      - name: Ensure stable exists (install/update)
        run: |
          export KUBECONFIG=$(pwd)/kubeconfig
          helm upgrade --install $RELEASE_NAME $CHART_PATH --set nameOverride=$RELEASE_NAME --set image.repository=${{ secrets.REGISTRY_HOST }}/${{ secrets.REGISTRY_REPO }},image.tag=${{ github.sha }}

      - name: Deploy canary release (low weight)
        run: |
          export KUBECONFIG=$(pwd)/kubeconfig
          helm upgrade --install $RELEASE_NAME-canary $CHART_PATH --set nameOverride=$RELEASE_NAME --set image.repository=${{ secrets.REGISTRY_HOST }}/${{ secrets.REGISTRY_REPO }},canary.enabled=true --set canary.image.tag=${{ github.sha }} --set canary.weight=10

      - name: Wait for canary pods ready
        run: |
          export KUBECONFIG=$(pwd)/kubeconfig
          echo "Waiting for canary pods..."
          kubectl wait --for=condition=available --timeout=120s deploy/$RELEASE_NAME-canary || true
          sleep 10

      - name: Port-forward, run smoke tests, and evaluate metrics
        env:
          OBSERVATION_PORT: ${{ env.OBSERVATION_PORT }}
        run: |
          export KUBECONFIG=$(pwd)/kubeconfig
          # start port-forward in background
          kubectl port-forward svc/${{ env.RELEASE_NAME }}-canary-svc ${{ env.OBSERVATION_PORT }}:8000 --kubeconfig kubeconfig >/tmp/portfw.log 2>&1 &
          sleep 4
          set -e
          # smoke tests
          curl -sS --fail http://127.0.0.1:${OBSERVATION_PORT}/health/ || { echo "health failed"; exit 1; }
          curl -sS --fail -X POST http://127.0.0.1:${OBSERVATION_PORT}/predict/ -H "Content-Type: application/json" -d '{"features":[[5.1,3.5,1.4,0.2]]}' || { echo "predict failed"; exit 1; }
          echo "smoke tests ok"
          # evaluate metrics
          METRIC=$(curl -sS http://127.0.0.1:${OBSERVATION_PORT}/metrics | awk '/^ml_model_accuracy /{print $2; exit}')
          echo "raw ml_model_accuracy=$METRIC"
          if [ -z "$METRIC" ]; then
            echo "Metric ml_model_accuracy not found. Failing gate."
            # uninstall canary before fail
            export KUBECONFIG=$(pwd)/kubeconfig
            helm uninstall $RELEASE_NAME-canary || true
            exit 1
          fi
          # export METRIC for Python subprocess
          export METRIC
          # evaluate threshold using Python for robust float comparison
          python - <<PY
import os,sys
try:
    m=float(os.environ.get("METRIC","0"))
except:
    print("Cannot parse metric")
    sys.exit(2)
threshold=0.70
print(f"ml_model_accuracy={m}, threshold={threshold}")
if m >= threshold:
    print("Metric threshold satisfied -> PROMOTE")
    sys.exit(0)
else:
    print("Metric below threshold -> ROLLBACK")
    sys.exit(3)
PY
          EVAL_EXIT_CODE=$?
          if [ $EVAL_EXIT_CODE -eq 3 ]; then
            echo "Metric threshold not met. Uninstalling canary and failing gate."
            export KUBECONFIG=$(pwd)/kubeconfig
            helm uninstall $RELEASE_NAME-canary || true
            exit 1
          elif [ $EVAL_EXIT_CODE -ne 0 ]; then
            exit $EVAL_EXIT_CODE
          fi

      - name: Promote canary to stable
        if: ${{ success() }}
        run: |
          export KUBECONFIG=$(pwd)/kubeconfig
          helm upgrade --install $RELEASE_NAME $CHART_PATH --set nameOverride=$RELEASE_NAME --set image.repository=${{ secrets.REGISTRY_HOST }}/${{ secrets.REGISTRY_REPO }},image.tag=${{ github.sha }}
          helm uninstall $RELEASE_NAME-canary || true
