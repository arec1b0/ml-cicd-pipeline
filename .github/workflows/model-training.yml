name: Model Training & Package

on:
  workflow_dispatch:
  push:
    branches: [ main ]
    paths:
      - "src/models/**"
      - "src/data/**"

jobs:
  train:
    runs-on: ubuntu-latest
    outputs:
      model_uri: ${{ steps.train.outputs.model_uri }}
      run_id: ${{ steps.train.outputs.run_id }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install poetry
          poetry config virtualenvs.create false
          poetry install --no-interaction --no-ansi

      - name: Run training and register model with MLflow
        id: train
        env:
          MLFLOW_TRACKING_URI: ${{ secrets.MLFLOW_TRACKING_URI }}
          MLFLOW_EXPERIMENT_NAME: ${{ secrets.MLFLOW_EXPERIMENT_NAME }}
          MLFLOW_MODEL_NAME: ${{ secrets.MLFLOW_MODEL_NAME }}
        run: |
          set -eo pipefail
          OUTPUT=$(poetry run python -m src.models.trainer | tee /tmp/train.log)
          echo "$OUTPUT"
          MODEL_URI=$(echo "$OUTPUT" | grep -E 'MODEL_URI=' | tail -n1 | cut -d= -f2-)
          if [ -z "$MODEL_URI" ]; then
            echo "Failed to parse MODEL_URI from trainer output."
            exit 1
          fi
          RUN_ID=$(echo "$OUTPUT" | grep -E 'run_id=' | head -n1 | sed -n 's/.*run_id=\([^,)]*\).*/\1/p')
          echo "model_uri=$MODEL_URI" >> "$GITHUB_OUTPUT"
          if [ -n "$RUN_ID" ]; then
            echo "run_id=$RUN_ID" >> "$GITHUB_OUTPUT"
          fi
