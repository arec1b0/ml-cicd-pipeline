services:
  api:
    build:
      context: .
      dockerfile: docker/Dockerfile
    image: ml-cicd-pipeline:local
    ports:
      - "8000:8000"
    environment:
      - MODEL_SOURCE=mlflow
      - MODEL_CACHE_DIR=/var/cache/ml-model
      - MLFLOW_TRACKING_URI=${MLFLOW_TRACKING_URI:-http://localhost:5000}
      - MLFLOW_MODEL_NAME=${MLFLOW_MODEL_NAME:-iris-random-forest}
      - MLFLOW_MODEL_STAGE=${MLFLOW_MODEL_STAGE:-Production}
      - MODEL_AUTO_REFRESH_SECONDS=${MODEL_AUTO_REFRESH_SECONDS:-300}
      - MLFLOW_TRACKING_USERNAME=${MLFLOW_TRACKING_USERNAME:-}
      - MLFLOW_TRACKING_PASSWORD=${MLFLOW_TRACKING_PASSWORD:-}
      # EXPECTED_FEATURE_DIMENSION: Optional override for model input dimension
      # Default: 4 (Iris dataset), but automatically derived from model metadata at startup
      # - EXPECTED_FEATURE_DIMENSION=${EXPECTED_FEATURE_DIMENSION:-4}
      # SECURITY: ADMIN_API_TOKEN must be explicitly set - no default value provided
      # Generate a secure token: openssl rand -hex 32
      - ADMIN_API_TOKEN=${ADMIN_API_TOKEN:?ADMIN_API_TOKEN must be explicitly set for security}
      - ADMIN_TOKEN_HEADER=${ADMIN_TOKEN_HEADER:-X-Admin-Token}
      - LOG_LEVEL=INFO
    volumes:
      - model-cache:/var/cache/ml-model
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 512M
        reservations:
          cpus: '0.1'
          memory: 256M

  drift-monitor:
    build:
      context: .
      dockerfile: docker/Dockerfile.drift-monitor
    image: ml-cicd-pipeline-drift-monitor:local
    ports:
      - "9000:9000"
    environment:
      - REFERENCE_DATASET_URI=${REFERENCE_DATASET_URI:-/data/reference/train_reference.csv}
      - CURRENT_DATASET_URI=${CURRENT_DATASET_URI:-/data/current/prediction_events.jsonl}
      - DRIFT_EVALUATION_INTERVAL_SECONDS=${DRIFT_EVALUATION_INTERVAL_SECONDS:-300}
      - DRIFT_MIN_ROWS=${DRIFT_MIN_ROWS:-50}
    volumes:
      - ./drift-data:/data
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 512M
        reservations:
          cpus: '0.1'
          memory: 256M

volumes:
  model-cache:
